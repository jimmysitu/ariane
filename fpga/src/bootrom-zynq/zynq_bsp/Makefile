# Makefile generated by Xilinx.
# Jimmy Situ: Porting to RISC-V

PROCESSOR = ariane_zynq
LIBRARIES = ${PROCESSOR}/lib/libxil.a
BSP_MAKEFILES := $(wildcard $(PROCESSOR)/libsrc/*/src/Makefile)
SUBDIRS := $(patsubst %/Makefile, %, $(BSP_MAKEFILES))

ifneq (,$(findstring win,$(RDI_PLATFORM)))
 SHELL = CMD
endif

all: libs
	@echo 'Finished building libraries'

include: $(addsuffix /make.include,$(SUBDIRS))

libs: $(addsuffix /make.libs,$(SUBDIRS))

clean: $(addsuffix /make.clean,$(SUBDIRS))

release_dir:
	mkdir -p $(PROCESSOR)/lib

$(PROCESSOR)/lib/libxil.a: $(PROCESSOR)/lib/libxil_init.a
	cp -f $< $@

%/make.include: $(if $(wildcard $(PROCESSOR)/lib/libxil_init.a),$(PROCESSOR)/lib/libxil.a,)
	@echo "Running Make include in $(subst /make.include,,$@)"
	$(MAKE) -C $(subst /make.include,,$@) -s include  \
		"SHELL=$(SHELL)" "COMPILER=riscv64-unknown-elf-gcc" \
		"ARCHIVER=riscv64-unknown-elf-ar" \
		"COMPILER_FLAGS= -O0 -c -march=rv64gc -mabi=lp64d -Wall -mcmodel=medany -mexplicit-relocs" \
		"EXTRA_COMPILER_FLAGS=-nostdlib -nodefaultlibs -nostartfiles -ggdb -Wall -Wextra"

%/make.libs: include release_dir
	@echo "Running Make libs in $(subst /make.libs,,$@)"
	$(MAKE) -C $(subst /make.libs,,$@) -s libs \
		"SHELL=$(SHELL)" "COMPILER=riscv64-unknown-elf-gcc" \
		"ARCHIVER=riscv64-unknown-elf-ar" \
		"COMPILER_FLAGS=  -O0 -c -march=rv64gc -mabi=lp64d -Wall -mcmodel=medany -mexplicit-relocs" \
		"EXTRA_COMPILER_FLAGS=-ggdb -Wall -Wextra"

%/make.clean:
	$(MAKE) -C $(subst /make.clean,,$@) -s clean

clean:
	rm -f ${PROCESSOR}/lib/libxil.a
